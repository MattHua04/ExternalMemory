; ExternalMemoryTest.asm

ORG 0
; Test normal memory mode
Normal:
    ; Set memory mode to normal
    LOADI &B00
    OUT ExtMemMode

    ; Set metadata to unavailable, read, write
    LOAD &B011
    OUT ExtMemMeta

    ; Set address to 0
    LOADI 0
    OUT ExtMemAddr

    ; Write some data to external memory
    LOADI &B10101010
    SHIFT 8
    ADDI &B10101010
    OUT ExtMem
    CALL WaitToContinue

    ; Read the data back
    LOADI 0
    OUT ExtMemAddr
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue

; Test stack memory mode
Stack:
    ; Set memory mode to stack
    LOADI &B01
    OUT ExtMemMode

    ; Set metadata to unavailable, read, write
    LOAD &B011
    OUT ExtMemMeta

    ; Write some data to external memory
    LOADI 1
    OUT ExtMem
    LOADI 2
    OUT ExtMem
    LOADI 3
    OUT ExtMem
    CALL WaitToContinue

    ; Read the data back
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue

; Test queue memory mode
Queue:
    ; Set memory mode to queue
    LOADI &B10
    OUT ExtMemMode

    ; Set metadata to unavailable, read, write
    LOAD &B011
    OUT ExtMemMeta

    ; Write some data to external memory
    LOADI 1
    OUT ExtMem
    LOADI 2
    OUT ExtMem
    LOADI 3
    OUT ExtMem
    CALL WaitToContinue

    ; Read the data back
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue

; Test circular buffer memory mode
Circular:
    ; Set memory mode to queue
    LOADI &B10
    OUT ExtMemMode

    ; Set metadata to unavailable, read, write
    LOAD &B011
    OUT ExtMemMeta

    ; Write some data to external memory
    LOADI 1
    OUT ExtMem
    LOADI 1
    OUT ExtMem
    LOADI 3
    OUT ExtMem
    CALL WaitToContinue

    ; Read the data back
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue
    IN ExtMem
    OUT LEDs
    CALL WaitToContinue

; Wait for switch to be toggled
WaitToContinue:
    ; Wait for switch up
    Up:
        CALL Sleep
        LOAD Switches
        AND One
        JZERO Up
    ; Wait for switch down
    Down:
        CALL Sleep
        LOAD Switches
        AND One
        JZERO Down
    RETURN

; Sleep for 0.1 seconds
Sleep:
    OUT Timer
    WaitingLoop:
        IN Timer
        ADDI -1
        JNEG WaitingLoop
    RETURN

;
One: DW 1
; IO address constants
Switches: EQU 000
LEDs: EQU 001
Timer: EQU 002
Hex0: EQU 004
Hex1: EQU 005
ExtMem: EQU 070
ExtMemMode: EQU 071
ExtMemAddr: EQU 072
ExtMemMeta: EQU 073
ExtMemClear: EQU 074
